> ***2022.01.17***

------

## 3.7 过程（Procedures）

过程是一种抽象。它提供了一种封装代码的方式，用一组指定的参数和一个可选的返回值，实现了某种功能。过程有很多形式：函数（function），方法（method），子例程（subroutine）、处理函数（handler）。

假设过程P调用过程Q。Q执行后返回到P。这些动作必须包括下面一个或多个机制：

- 传递控制。
- 传递数据。
- 分配和释放内存。

### 3.7.1 运行时栈（The Run-Time Stack）

C语言过程调用机制的关键特性在于使用了栈数据结构提供的后进先出原则。当P调用Q时，控制和数据信息添加到栈尾。当P返回时，这些信息会被释放。

栈的向低地址方向增长，而栈指针`%rsp`执行栈顶元素，可以使用`pushq`和`popq`指令将数据存入栈中或者是从栈中取出。将栈指针见效一个适当的亮可以为没有指定初始值的数据在栈上分配空间。也可以通过增加栈指针来释放空间。

当过程需要的存储空间超出寄存器能够存放的大小时，就会在栈上分配空间，成为过程的栈帧（stack farm）。

### 3.7.2 转移控制（Control Transfer）

将控制从函数P转移到函数Q只要把程序计数器（PC）设置为Q的代码起始位置。当从Q返回的时候，处理器必须要记录好它需要继续P的执行的代码位置。

在x86-64机器只能够，这个信息是用`call Q`调用过程Q来记录的。该执行会把地址A压入栈中，并将PC设置为Q的起始地址。压入的地址A被称为返回地址，是紧跟在call指令后的那条指令的地址。对应的ret会从栈中弹出地址A，并把PC设置为A。

call和ret指令的一般形式：

| 指令          | 描述             |
| ------------- | ---------------- |
| call Lael     | 过程调用         |
| call *Operand | 过程调用         |
| ret           | 从过程调用中返回 |

`call`有一个目标，指明被调用过程起始的指令地址。调用可以指直接的或者是间接的。