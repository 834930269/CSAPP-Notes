# Ch3 Machine-Level Representation of Programs

## 3.7 Procedures

**栈上的局部存储**

局部数据必须存放在内存中的情况有：

* 寄存器不足够存放所有的本地数据；
* 需要对局部变量使用 `&` 取地址运算，因此必须有内存地址；
* 数组或者是结构体，需要特殊处理才能访问其成员。

在栈上为“局部变量”分配存储空间，通过减少栈指针来分配内存空间，这部分内存空间存储着局部变量，也是栈帧的一部分。



**寄存器中的局部存储空间**

寄存器是被所有过程共享的资源，在过程调用切换时候，需要确保一个过程调用另一个过程时，被调用者不会覆盖调用者稍后会使用的寄存器值。因此，x86-64 规范了寄存器的使用惯例。

X86-64中，

* callee save：寄存器 `%rbx`、`%rbp`，和 `%r12 ~%r15` 为**被调用者保存寄存器**。
    * 过程 P 调用过程 Q时，Q 必须保存寄存器的值不变；
    * 过程 Q 开始时会把寄存器原始值压入栈中，然后再去改变寄存器的值，在返回前从栈中弹出旧值。
* caller save：除了`%rsp` 和以上的寄存器，都为**调用者保存寄存器**。



**递归过程**

栈帧能提供一种机制，每次函数调用都有它自己私有的状态信息（返回位置，寄存器值，局部变量），依据栈的分配和释放的规则，使得机器能支持递归。

