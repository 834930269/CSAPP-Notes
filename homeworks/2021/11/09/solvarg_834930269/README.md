# Chapter.8 异常控制流

pre Chapter 3.7

--------------

## 编写信号处理程序

信号处理程序和主程序以及其他信号处理程序并发运行,

建议:  

- G0: 处理程序要尽可能简单,避免麻烦的最好方法是保持处理程序尽可能小和简单。`信号处理程序`可能只是简单地设置全局标志并立即返回,**所有与接收信号相关的处理都由主程序执行**,它周期性的检查这个标志.  
- G1: 在处理程序中只调用异步信号安全的函数,**即安全的函数**,相应的函数列表见CSAPP P 534  
    - 信号处理程序中唯一安全的输出是`write`函数,
- G2: 保存和恢复`errno`,许多异步信号安全的函数都会在出错返回时社会errno,在处理程序中调用这样的函数可能会干扰主程序中其他依赖`errno`的部分,正确的做法是把`errno`保存一个局部变量,**在处理程序需要返回时恢复它**
- G3: 阻塞所有信号,保护对全局数据结构的访问,以防止在处理程序运行时被其他信号中断
- G4: 用`volatile`声明全局变量。他们共享一个全局变量g。处理程序更新g,main函数周期性读取g.使用volatile限定符来定义一个变量,就会告诉编译器**不要优化和缓存这个变量**,所以,配合阻塞其他信号时是安全的
- G5: sig_automic_t
    - 即 volatile sig_automic_t flag;保证操作是原子的,不需要中断


## 可移植信号处理

- `signal`函数的语义各有不同,
- `系统调用可以被中断`,再早些的Unix系统上,类似于read、write、accept这样的慢速系统调用可能会被中断,在调用过程中不再继续,并返回给用于Errno

所以为了解决这个问题,我们通常使用`Signal包装函数`

这个函数可以自动重启被中断的系统调用

--------------


> Latex转Svg

https://www.latexlive.com/