# Ch4 Processor Architecture

## 4.5 Pipelined Y86-64 Implementations

**Exception Handling**

异常的来源：

* 内部产生：
    1. `halt` 指令；
    2. 非法指令和功能组合的指令；
    3. 取指或者数据读写时的非法内存地址。

* 外部信号：例如网络接口收到新包，或者是鼠标点击信号等。

流水线化的系统中的异常处理细节问题：

1. 同时产生多个异常。流水线最深的指令引起的异常，优先级最高，按照优先级来向操作系统上报。

2. 流水线预测分支失败，但是已经预测错误的分支的指令产生了异常，后面指令取消。

3. 流水线化的处理器再不同阶段更新了系统不同部分的状态。

    通过在流水线中加入异常处理逻辑，PIPE 实现中在流水线寄存器中加入了状态码 `Stat`，状态码信息和指令的其他信息沿着流水线一起传播，到写回阶段发生异常，然后停止。

    如何避免异常指令之后的指令**更新程序员可见的状态**？

    * 处于访存和写回阶段中的指令产生异常时，流水线控制逻辑必须禁止更新条件码寄存器或数据内存。
    * 当出现异常时，信息存放在流水线寄存器的状态字段中，并禁止流水线后面的指令更新程序员可见的状态，直到异常指令达到流水线最后阶段，此时程序直接停止，可以保证流水线寄存器中的状态码会被记录为程序状态；如果该指令取消了，直接将异常状态信息取消即可。

