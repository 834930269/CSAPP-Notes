# Ch4 Processor Architecture

## 4.5 Pipelined Y86-64 Implementations

**Next PC Prediction**

指令流水线设计的目的是为了每个时钟周期发射一条新指令，也就是说每个时钟周期都有一条新指令经历执行阶段并执行完成。要做到上述目的，必须在取出当前指令后，马上确定下一条指令的位置；但是对于条件分支指令 和 `ret` 指令来说，无法在取指阶段准确的知道下一条指令的地址。

确定下一条指令：

* 大多数指令，都是 PC INCREMENT 操作获得；
* 对于 `call` 和 `jmp`，都是指令中的常数 `valC`；
* 对于条件转移，下一个地址是要在执行阶段才能确定，因此预测选择分支，下一条指令为`valC`，否则为 `valP`;
    * 分支预测技术来解决这个问题，Y86-64 中总是预测选择分支；其他系统会花费大量硬件来解决这个问题；
    * 常见的预测策略有：总是选择（always taken），从不选择（never taken），反向选择正向不选择（backward taken，forward not-taken，BTFNT）。三种策略的成功率分别为 60%、40%、65%。
* 对于 `ret` 指令，转移条件的不同，导致了可能的返回值是位于栈顶的字，因此难以预测；
    * Y86-64 实现中，不对返回地址做预测，这种情况下，停止处理新指令，直到 `ret` 指令完成写回阶段再开始流水线。

PIPE- 的取指阶段，有一个 `Predict PC` 块，从三个值中进行选择：预测的 PC；`M_valA`（流水线寄存器 M 的不选择分支的指令，`valP`）；`W_valM`（`ret` 指令到达流水线寄存器 W 的返回地址）。

