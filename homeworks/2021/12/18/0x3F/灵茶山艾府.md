# 章节 9 虚拟存储器

#### Linux 缺页异常处理

1. 判断虚拟地址是否合法：缺页处理程序搜索区域结构的链表，把虚拟地址和每个区域结构中的 `vm_start` 和 `vm_end` 做比较。如果这个指令是不合法的，那么缺页处理程序就触发一个段错误，从而终止这个进程。
注意：顺序搜索区域结构的链表花销可能会很大，在实际中，Linux 在链表中构建了一棵树，并在这棵树上进行查找。
2. 判断试图进行的内存访问是否合法：判断进程是否有读、写或者执行这个区域内页面的权限。如果试图进行的访问是不合法的，那么缺页处理程序会触发一个保护异常，从而终止这个进程。
3. 此时内核判定该缺页是由于对合法的虚拟地址进行合法的操作造成的。
4. 选择一个牺牲页面，如果这个牺牲页面被修改过，那么就将它交换出去，换入新的页面并更新页表。
5. 当缺页处理程序返回时，CPU 重新启动引起缺页的指令，这条指令将再次发送虚拟地址到 MMU。这次，MMU 就能正常地翻译 A，而不会再产生缺页中断了。
